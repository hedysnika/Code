```env filename=".env"  copy
AWS_ACCESS_KEY_ID=yourkey
AWS_SECRET_ACCESS_KEY=yourkey
AWS_REGION=eu-central-1 or your AWS Region
BUCKET_NAME=Your Bucket name
```

```env filename=".env"  copy
AWS_ACCESS_KEY_ID=yourkey
AWS_SECRET_ACCESS_KEY=yourkey
AWS_REGION=eu-central-1 or your AWS Region
BUCKET_NAME=Your Bucket name
```


```ts filename="aws-s3-stack.ts"  copy
import * as iam from 'aws-cdk-lib/aws-iam'
import * as s3 from 'aws-cdk-lib/aws-s3'
import * as cdk from 'aws-cdk-lib'
import { Construct } from 'constructs'

export class AwsS3Stack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props)

    const bucket = new s3.Bucket(this, 'my-bucket', {
      removalPolicy: cdk.RemovalPolicy.DESTROY,
      cors: [
        {
          allowedHeaders: ['*'],
          allowedOrigins: ['*'],
          allowedMethods: [s3.HttpMethods.POST],
        },
      ],
    })

    bucket.addToResourcePolicy(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        principals: [new iam.ServicePrincipal('lambda.amazonaws.com')],
        actions: ['s3:GetObject'],
        resources: [`${bucket.bucketArn}/*`],
      })
    )

    bucket.policy?.document.addStatements(
      new iam.PolicyStatement({
        effect: iam.Effect.ALLOW,
        principals: [new iam.ServicePrincipal('lambda.amazonaws.com')],
        actions: ['s3:GetBucketTagging'],
        resources: [bucket.bucketArn],
      })
    )
  }
}
```

```ts filename="upload-url.ts"  copy
import S3 from 'aws-sdk/clients/s3'
import { NextApiRequest, NextApiResponse } from 'next'

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const s3 = new S3({
    apiVersion: '2006-03-01',
  })

  const post = await s3.createPresignedPost({
    Bucket: process.env.BUCKET_NAME,
    Fields: {
      key: req.query.file,
      'Content-Type': req.query.fileType,
    },
    Expires: 60, // seconds
    Conditions: [
      ['content-length-range', 0, 1048576], // up to 1 MB
    ],
  })

  res.status(200).json(post)
}
```
Front End upload function example for photos
```tsx filename="index.tsx"  copy
  const [uploadedImageUrl, setUploadedImageUrl] = useState("");
  const [selectedFile, setSelectedFile] = useState<File | null>(null);




  const uploadPhoto = async (file: File | null) => {
    if (!file) return;

    const filename = encodeURIComponent(file.name);
    const fileType = encodeURIComponent(file.type);

    const res = await fetch(
      `/api/upload-url?file=${filename}&fileType=${fileType}`
    );
    const { url, fields } = await res.json();
    const formData = new FormData();

    Object.entries({ ...fields, file }).forEach(([key, value]) => {
      formData.append(key, value as string);
    });

    const upload = await fetch(url, {
      method: 'POST',
      body: formData,
    });

    if (upload.ok) {
      console.log('Uploaded successfully!');
      const imageUrl = `https://audioplayertest1.s3.amazonaws.com/${filename}`;
      setUploadedImageUrl(imageUrl);
    } else {
      console.error('Upload failed.');
    }
  };

    useEffect(() => {
    uploadPhoto(selectedFile);
  }, [selectedFile]);

```

Front End upload function example for Songs
```tsx filename="index.tsx"  copy
  const [uploadedMusicUrl, setUploadedMusicUrl ] = useState("")
  const [selectedSong, setSelectedSong] = useState<File | null>(null);


  const uploadSong = async (file: File | null) => {
    if (!file) return;

    const filename = encodeURIComponent(file.name);
    const fileType = encodeURIComponent(file.type);

    const res = await fetch(
      `/api/upload-song?file=${filename}&fileType=${fileType}`
    );
    const { url, fields } = await res.json();
    const formData = new FormData();

    Object.entries({ ...fields, file }).forEach(([key, value]) => {
      formData.append(key, value as string);
    });

    const upload = await fetch(url, {
      method: 'POST',
      body: formData,
    });

    if (upload.ok) {
      console.log('Uploaded successfully!');
      const audioUrl = `https://audioplayertest1.s3.amazonaws.com/${filename}`;
      setUploadedMusicUrl(audioUrl);
    } else {
      console.error('Upload failed.');
    }
  };

    useEffect(() => {
    uploadSong(selectedSong);
  }, [selectedSong]);

```
